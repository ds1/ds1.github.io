<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="robots" content="noindex" />
  <title>Content Manager</title>
</head>
<body>
  <!-- Include Decap CMS -->
  <script src="https://unpkg.com/decap-cms@^3.1.10/dist/decap-cms.js"></script>
  <script>
    // Register preview styles
    CMS.registerPreviewStyle("/admin/preview.css");
    
    // Helper function to render markdown content
    var renderMarkdown = function(content) {
      if (!content) return '';
      
      // Ensure content is a string
      content = String(content);
      
      // Basic markdown to HTML conversion
      var html = content;
      
      // Convert headings
      html = html.replace(/^### (.*$)/gim, '<h3>$1</h3>');
      html = html.replace(/^## (.*$)/gim, '<h2>$1</h2>');
      html = html.replace(/^# (.*$)/gim, '<h1>$1</h1>');
      
      // Convert bold and italic
      html = html.replace(/\*\*\*(.*?)\*\*\*/g, '<strong><em>$1</em></strong>');
      html = html.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
      html = html.replace(/\*(.*?)\*/g, '<em>$1</em>');
      
      // Convert line breaks  
      html = html.replace(/\\n\\n/g, '</p><p>');
      html = html.replace(/\\n/g, '<br>');
      
      // Wrap in paragraph tags if needed
      if (html && !html.startsWith('<')) {
        html = '<p>' + html + '</p>';
      }
      
      // Handle color spans
      html = html.replace(/<span class="(text-[^"]+)">/g, '<span class="$1">');
      
      return html;
    };
    
    // Helper to render list from markdown
    var renderList = function(content) {
      if (!content) return '';
      
      content = String(content);
      
      // Check if it's semicolon-separated
      if (content.includes(';') && !content.includes('\n')) {
        var items = content.split(';').filter(function(item) { return item.trim(); });
        return '<ul>' + items.map(function(item) {
          return '<li>' + item.trim() + '</li>';
        }).join('') + '</ul>';
      }
      
      // Otherwise treat as markdown list
      var html = content;
      html = html.replace(/^\* (.+)$/gm, '<li>$1</li>');
      html = html.replace(/^- (.+)$/gm, '<li>$1</li>');
      html = html.replace(/^\d+\. (.+)$/gm, '<li>$1</li>');
      
      if (html.includes('<li>')) {
        html = '<ul>' + html + '</ul>';
      }
      
      return html;
    };
    
    // Create flexible preview template for Case Studies
    var CaseStudyPreview = createClass({
      render: function() {
        var entry = this.props.entry;
        var sections = entry.getIn(['data', 'content_sections']);
        
        // Build array of child elements
        var children = [];
        
        // Add title
        var title = entry.getIn(['data', 'title']);
        if (title) {
          children.push(h('h1', {key: 'title'}, title));
        }
        
        // Add subtitle
        var subtitle = entry.getIn(['data', 'subtitle']);
        if (subtitle) {
          children.push(h('p', {
            key: 'subtitle',
            style: 'font-size: 1.25rem; color: #8be9fd;'
          }, subtitle));
        }
        
        // Add metadata
        var duration = entry.getIn(['data', 'duration']);
        var role = entry.getIn(['data', 'role']); 
        var projectType = entry.getIn(['data', 'project_type']);
        
        if (duration || role || projectType) {
          var metaChildren = [];
          if (duration) metaChildren.push(h('span', {key: 'meta-duration'}, duration));
          if (role) metaChildren.push(h('span', {key: 'meta-role'}, role));
          if (projectType) metaChildren.push(h('span', {key: 'meta-type'}, projectType));
          
          children.push(h('div', {
            key: 'metadata',
            className: 'case-study-meta'
          }, metaChildren));
        }
        
        // Process content sections
        if (sections && sections.size > 0) {
          var sectionElements = [];
          
          // Convert Immutable List to regular array for safer iteration
          var sectionsArray = sections.toJS ? sections.toJS() : sections;
          
          if (Array.isArray(sectionsArray)) {
            sectionsArray.forEach(function(section, index) {
              if (!section || !section.content) return;
              
              var key = 'section-' + index;
              var type = section.type;
              var content = section.content;
              
              switch(type) {
                case 'h1':
                  sectionElements.push(h('h1', {key: key}, content));
                  break;
                case 'h2':
                  sectionElements.push(h('h2', {key: key}, content));
                  break;
                case 'h3':
                  sectionElements.push(h('h3', {key: key}, content));
                  break;
                case 'body':
                  sectionElements.push(h('div', {
                    key: key,
                    dangerouslySetInnerHTML: {__html: renderMarkdown(content)}
                  }));
                  break;
                case 'list':
                  sectionElements.push(h('div', {
                    key: key,
                    dangerouslySetInnerHTML: {__html: renderList(content)}
                  }));
                  break;
                case 'quote':
                  sectionElements.push(h('blockquote', {key: key}, content));
                  break;
                case 'code':
                  sectionElements.push(h('pre', {key: key}, 
                    h('code', {}, content)
                  ));
                  break;
                default:
                  sectionElements.push(h('p', {key: key}, content));
              }
            });
          }
          
          // Add all section elements to children
          children = children.concat(sectionElements);
        }
        
        // Return single root div with all children
        return h('div', {className: 'frame-content'}, children);
      }
    });
    
    // Register the preview template
    CMS.registerPreviewTemplate("case_studies", CaseStudyPreview);
  </script>
</body>
</html>