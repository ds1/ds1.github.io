<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="robots" content="noindex" />
  <title>Content Manager</title>
</head>
<body>
  <!-- Include Decap CMS -->
  <script src="https://unpkg.com/decap-cms@^3.1.10/dist/decap-cms.js"></script>
  <script>
    // Register preview styles
    CMS.registerPreviewStyle("/admin/preview.css");
    
    // Simplified markdown renderer - CHANGE: Made more efficient
    var renderMarkdown = function(content) {
      if (!content) return '';
      
      // Use CMS's built-in markdown parser if available
      if (window.CMS && window.CMS.markdownToHtml) {
        return window.CMS.markdownToHtml(content);
      }
      
      // Fallback to basic conversion
      content = String(content);
      var html = content;
      
      // Batch all regex replacements for better performance
      html = html
        .replace(/^### (.*$)/gim, '<h3>$1</h3>')
        .replace(/^## (.*$)/gim, '<h2>$1</h2>')
        .replace(/^# (.*$)/gim, '<h1>$1</h1>')
        .replace(/\*\*\*(.*?)\*\*\*/g, '<strong><em>$1</em></strong>')
        .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
        .replace(/\*(.*?)\*/g, '<em>$1</em>')
        .replace(/\\n\\n/g, '</p><p>')
        .replace(/\\n/g, '<br>');
      
      if (html && !html.startsWith('<')) {
        html = '<p>' + html + '</p>';
      }
      
      return html;
    };
    
    // Optimized list renderer - CHANGE: More efficient
    var renderList = function(content) {
      if (!content) return '';
      
      content = String(content);
      
      if (content.includes(';')) {
        var items = content.split(';')
          .map(function(item) { return item.trim(); })
          .filter(Boolean);
        
        return '<ul>' + items.map(function(item) {
          return '<li>' + item + '</li>';
        }).join('') + '</ul>';
      }
      
      // For markdown lists
      var lines = content.split('\n');
      var listItems = [];
      
      lines.forEach(function(line) {
        var match = line.match(/^[\*\-\d+]\.\s+(.+)$/);
        if (match) {
          listItems.push('<li>' + match[1] + '</li>');
        }
      });
      
      return listItems.length > 0 ? '<ul>' + listItems.join('') + '</ul>' : content;
    };
    
    // CHANGE: Optimized preview component with deferred rendering
    var CaseStudyPreview = createClass({
      getInitialState: function() {
        return { rendered: false };
      },
      
      componentDidMount: function() {
        // Defer heavy rendering to next tick
        var self = this;
        setTimeout(function() {
          self.setState({ rendered: true });
        }, 0);
      },
      
      render: function() {
        var entry = this.props.entry;
        
        // Show loading state initially
        if (!this.state.rendered) {
          return h('div', {className: 'frame-content'}, 
            h('p', {}, 'Loading preview...')
          );
        }
        
        // Build preview content
        var children = [];
        
        // Add title
        var title = entry.getIn(['data', 'title']);
        if (title) {
          children.push(h('h1', {key: 'title'}, title));
        }
        
        // Add subtitle
        var subtitle = entry.getIn(['data', 'subtitle']);
        if (subtitle) {
          children.push(h('p', {
            key: 'subtitle',
            className: 'subtitle'
          }, subtitle));
        }
        
        // Add metadata
        var duration = entry.getIn(['data', 'duration']);
        var role = entry.getIn(['data', 'role']); 
        var projectType = entry.getIn(['data', 'project_type']);
        
        if (duration || role || projectType) {
          var metaItems = [];
          if (duration) metaItems.push(duration);
          if (role) metaItems.push(role);
          if (projectType) metaItems.push(projectType);
          
          children.push(h('div', {
            key: 'metadata',
            className: 'case-study-meta'
          }, metaItems.join(' â€¢ ')));
        }
        
        // Process content sections with guard
        try {
          var sections = entry.getIn(['data', 'content_sections']);
          
          if (sections && sections.size > 0) {
            // CHANGE: Use forEach directly on Immutable List
            sections.forEach(function(section, index) {
              if (!section) return;
              
              var content = section.get('content');
              var type = section.get('type');
              
              if (!content) return;
              
              var key = 'section-' + index;
              
              switch(type) {
                case 'h1':
                  children.push(h('h1', {key: key}, content));
                  break;
                case 'h2':
                  children.push(h('h2', {key: key}, content));
                  break;
                case 'h3':
                  children.push(h('h3', {key: key}, content));
                  break;
                case 'body':
                  children.push(h('div', {
                    key: key,
                    className: 'rich-text',
                    dangerouslySetInnerHTML: {__html: renderMarkdown(content)}
                  }));
                  break;
                case 'list':
                  children.push(h('div', {
                    key: key,
                    className: 'list-content',
                    dangerouslySetInnerHTML: {__html: renderList(content)}
                  }));
                  break;
                case 'quote':
                  children.push(h('blockquote', {key: key}, content));
                  break;
                case 'code':
                  children.push(h('pre', {key: key}, 
                    h('code', {}, content)
                  ));
                  break;
                default:
                  children.push(h('p', {key: key}, content));
              }
            });
          }
        } catch (error) {
          console.error('Error rendering sections:', error);
          children.push(h('p', {key: 'error', className: 'error'}, 
            'Error rendering content sections'
          ));
        }
        
        return h('div', {className: 'frame-content'}, children);
      }
    });
    
    // Register the preview template
    CMS.registerPreviewTemplate("case_studies", CaseStudyPreview);
    
    // CHANGE: Add error boundary for the entire CMS
    window.addEventListener('error', function(event) {
      console.error('CMS Preview Error:', event.error);
      // Prevent the error from bubbling up
      event.preventDefault();
    });
  </script>
</body>
</html>